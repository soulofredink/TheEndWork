{"version":3,"file":"communicateDetails.js","sources":["pages/communicateDetails/communicateDetails.vue","D:/HBuiderX/HBuilderX.4.64.2025042916/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY29tbXVuaWNhdGVEZXRhaWxzL2NvbW11bmljYXRlRGV0YWlscy52dWU"],"sourcesContent":["<template>\n\t<view class=\"main-container\">\n\t\t<scroll-view\n\t\t\tclass=\"chat-list\" \n\t\t\tscroll-y \n\t\t\t:scroll-into-view=\"scrollId\"\n\t\t\t:scroll-with-animation=\"true\"\n\t\t>\n\t\t\t<view\n\t\t\t\tv-for=\"(msg, index) in messages\" \n\t\t\t\t:key=\"msg.id\"\n\t\t\t\t:id=\"'msg'+index\"\n\t\t\t\tclass=\"message-container\"\n\t\t\t\t:class=\"[msg.isMe ? 'me' : 'other']\"\n\t\t\t>\n\t\t\t\t<image\n\t\t\t\t\tv-if=\"!msg.isMe\"\n\t\t\t\t\tclass=\"avatar\"\n\t\t\t\t\tsrc=\"/static/avatar-other.jpg\"\n\t\t\t\t\tmode=\"aspectFill\"\n\t\t\t\t/>\n\t\t\t\t<view class=\"bubble\">\n\t\t\t\t\t<text>{{ msg.content }}</text>\n\t\t\t\t</view>\n\t\t\t\t<image\n\t\t\t\t\tv-if=\"msg.isMe\"\n\t\t\t\t\tclass=\"avatar-me\"\n\t\t\t\t\tsrc=\"/static/avatar-me.jpg\"\n\t\t\t\t\tmode=\"aspectFill\"\n\t\t\t\t/>\n\t\t\t</view>\n\t\t</scroll-view>\n\t\t<view class=\"input-area\">\n\t\t\t<input \n\t\t\t\tclass=\"input\"\n\t\t\t\tv-model=\"inputText\"\n\t\t\t\tplaceholder=\"输入消息\"\n\t\t\t\tconfirm-type=\"send\"\n\t\t\t\t@confirm=\"sendMessage\"\n\t\t\t/>\n\t\t\t<button class=\"send-btn\" @click=\"sendMessage\">发送</button>\n\t\t</view>\n\t</view>\n</template>\n<script setup lang=\"ts\">\n\timport {onLoad} from '@dcloudio/uni-app'\r\n\timport { reactive,ref,nextTick, onMounted ,getCurrentInstance, computed, onUnmounted} from 'vue'\r\n\timport Vue from 'vue'\r\n\timport { useUserStore } from '../../store/useUserStore';\r\n\timport { useChatStore } from '../../store/chatStore';\r\n\timport {storeToRefs} from 'pinia'\r\n\timport websocketUtil from '../../script/webSocket';\n\timport { url0,url1 } from '../../config';\r\n\tconst chatStore = useChatStore()\r\n\tconst userStore = useUserStore()\r\n\t//uni.setStorageSync('userInfo',userStore.currentUser)\r\n\tconst inputText = ref('')\r\n\tconst scrollId = ref('')\r\n\tconst chatId = ref('')\r\n\tconst username = ref('')\r\n\tconst avatar = ref('')\r\n\tlet websocket: websocketUtil | null = null\r\n\t\r\n\t// 初始化 WebSocket\r\n\tconst initWebSocket = () => {\r\n\t  if (!userStore.currentUser?.id) return\r\n\t  \r\n\twebsocket = new websocketUtil(\r\n\t    url1+`${userStore.currentUser.id}`,\r\n\t    5000\r\n\t)\r\n\twebsocket.getMessage((res:any)=>{\r\n\t\tuni.__f__('log','at pages/communicateDetails/communicateDetails.vue:73',\"有人来消息了：\",res.sender)\r\n\t\tif (chatStore.sessions.find(s => s.id === res.sender)) {\r\n\t\t\tuni.__f__('log','at pages/communicateDetails/communicateDetails.vue:75',\"此消息的会话存在，不需要创建新的\")\r\n\t\t}\r\n\t\telse chatStore.createSession(res.sender)\r\n\t\tconst a=Date.now()\r\n\t\tconst s=a.toString()\r\n\t\tchatStore.handleIncomingMessage({\r\n\t\t\tid: s,\r\n\t\t\tcontent: res.content,\r\n\t\t\tsender: res.sender,\r\n\t\t\treceiver: userStore.currentUser.id,\r\n\t\t\ttimestamp:a\r\n\t\t})\r\n\t  \tuni.__f__('log','at pages/communicateDetails/communicateDetails.vue:87',res);\r\n\t  })\r\n\t}\r\n\t\r\n\t// 消息列表\r\n\tconst messages = computed(() => \r\n\t  chatStore.currentMessages.map(msg => ({\r\n\t    ...msg,\r\n\t    isMe: msg.sender === userStore.currentUser?.id\r\n\t  }))\r\n\t)\r\n\t\r\n\tinterface sendMessageTo{\r\n\t\tsender:string\r\n\t\tmessage:string\r\n\t\tsendTime:number\r\n\t\treceiver:string\r\n\t}\r\n\t// 发送消息\r\n\tconst sendMessage = () => {\r\n\t\t//去空格\r\n\t\t//uni.__f__('log','at pages/communicateDetails/communicateDetails.vue:108',\"000:\",userStore.currentUser.id)\r\n\t\tif (!inputText.value.trim()) return\r\n\t\t//加入本地\r\n\t\tchatStore.sendMessage(inputText.value.trim(),chatId.value)\r\n\t\tconst msg: sendMessageTo = {\r\n\t\t  sender:userStore.currentUser.id,\r\n\t\t  message: inputText.value,\r\n\t\t  sendTime: Date.now(),\r\n\t\t  receiver: chatId.value\r\n\t\t}\r\n\t\t//uni.__f__('log','at pages/communicateDetails/communicateDetails.vue:118',\"curid:\",chatId.value)\r\n\t\twebsocket.send(JSON.stringify(msg))\r\n\t\tinputText.value = ''\r\n\t\tscrollToBottom()\r\n\t}\r\n\t\r\n\t// 滚动到底部\r\n\tconst scrollToBottom = () => {\r\n\t  nextTick(() => {\r\n\t    if (chatStore.currentMessages.length > 0) {\r\n\t      scrollId.value = `msg${chatStore.currentMessages.length - 1}`\r\n\t    }\r\n\t  })\r\n\t}\r\n\t\r\n\t// 生命周期\r\n\tonMounted(() => {\r\n\t  initWebSocket()\r\n\t  scrollToBottom()\r\n\t})\r\n\t\r\n\tonUnmounted(() => {\r\n\t\twebsocket?.close()\r\n\t\tuni.__f__('log','at pages/communicateDetails/communicateDetails.vue:141',\"关闭成功\")\r\n\t\tchatStore.clearUnreadCount(chatStore.currentSessionId)\r\n\t\tchatStore.currentSessionId = ''\r\n\t})\r\n\t\r\n\tonLoad((chat)=>{\r\n\t\tchatId.value = chat.id || '未知ID'\r\n\t\tusername.value = chat.username || '匿名用户'\r\n\t\tavatar.value = chat.avatar ? decodeURIComponent(chat.avatar) : '/static/default-avatar.png'\r\n\t\t//uni.__f__('log','at pages/communicateDetails/communicateDetails.vue:150',\"123:\",userStore.meta.isLoggedin)\r\n\t\t//uni.setStorageSync('userInfo',userStore.currentUser)\r\n\t})\r\n\n</script>\n\n<style lang=\"scss\" scoped>\n.main-container {\n  height: 100vh;\n  background-color: #f0f2f5;\n  display: flex;\n  flex-direction: column;\n}\n\n.chat-list {\n  flex: 1;\n  padding: 20rpx 20rpx 0;\n  box-sizing: border-box;\n}\n\n.message-container {\n  display: flex;\n  align-items: flex-start;\n  margin-bottom: 30rpx;\n  padding: 0 20rpx;\n\n  // 自己消息\n  &.me {\n    flex-direction: row;  \n    justify-content: flex-end;  \n\n    .bubble {\n      background: #95ec69;\n      margin-left: 20rpx;  \n      order: 1; \n      border-radius: 10rpx;\n\t  padding: 18rpx 24rpx;\n\t  word-break: break-word; \n    }\n    \n    .avatar-me {\n      order: 2;  // 头像排在最后（右侧）\n      margin-left: 20rpx;  // 头像与气泡间距\n    }\n  }\n\n  // 他人消息\n  &.other {\n    flex-direction: row; \n    .bubble {\n      background: #ffffff;\n      margin-left: 20rpx;  \n      border-radius: 10rpx;\n\t  padding: 18rpx 24rpx;\n\t  word-break: break-word; \n    }\n    \n    .avatar {\n      order: -1;  \n    }\n  }\n}\n\n.avatar, .avatar-me {\n  width: 80rpx;\n  height: 80rpx;\n  border-radius: 50%;\n  flex-shrink: 0;\n  box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.1);\n}\n\n.input-area {\n  display: flex;\n  align-items: center;\n  padding: 30rpx 20rpx;\n  background: #ffffff;\n  border-top: 1rpx solid #e5e5e5;\n  margin-bottom: 10rpx;\n  .input {\n    flex: 1;\n    background: #f8f8f8;\n    border-radius: 48rpx;\n    padding: 20rpx 32rpx;\n    margin-right: 20rpx;\n    font-size: 30rpx;\n    transition: all 0.3s;\n\n    &:focus {\n      background: #f0f0f0;\n    }\n  }\n\n  .send-btn {\n    background: #07c160;\n    color: white;\n    border-radius: 48rpx;\n    padding: 0 40rpx;\n    height: 80rpx;\n    font-size: 30rpx;\n    transition: all 0.3s;\n    \n    &:active {\n      background: darken(#07c160, 8%);\n      transform: scale(0.96);\n    }\n  }\n}\n</style>\n","import MiniProgramPage from 'E:/uniappWorkSpace/SaltyFish/pages/communicateDetails/communicateDetails.vue'\nwx.createPage(MiniProgramPage)"],"names":["useChatStore","useUserStore","ref","websocketUtil","url1","uni","s","computed","nextTick","onMounted","onUnmounted","onLoad"],"mappings":";;;;;;;;;;AAqDC,UAAM,YAAYA,gBAAAA;AAClB,UAAM,YAAYC,mBAAAA;AAEZ,UAAA,YAAYC,kBAAI,EAAE;AAClB,UAAA,WAAWA,kBAAI,EAAE;AACjB,UAAA,SAASA,kBAAI,EAAE;AACf,UAAA,WAAWA,kBAAI,EAAE;AACjB,UAAA,SAASA,kBAAI,EAAE;AACrB,QAAI,YAAkC;AAGtC,UAAM,gBAAgB,MAAM;;AACtB,UAAA,GAAC,eAAU,gBAAV,mBAAuB;AAAI;AAElC,kBAAY,IAAIC,iBAAA;AAAA,QACZC,OAAAA,OAAK,GAAG,UAAU,YAAY,EAAE;AAAA,QAChC;AAAA,MAAA;AAEM,gBAAA,WAAW,CAAC,QAAU;AAC/BC,sBAAA,MAAI,MAAM,OAAM,yDAAwD,WAAU,IAAI,MAAM;AACxF,YAAA,UAAU,SAAS,KAAK,CAAAC,OAAKA,GAAE,OAAO,IAAI,MAAM,GAAG;AAClDD,wBAAAA,MAAA,MAAM,OAAM,yDAAwD,kBAAkB;AAAA,QAC3F;AACe,oBAAA,cAAc,IAAI,MAAM;AACjC,cAAA,IAAE,KAAK;AACP,cAAA,IAAE,EAAE;AACV,kBAAU,sBAAsB;AAAA,UAC/B,IAAI;AAAA,UACJ,SAAS,IAAI;AAAA,UACb,QAAQ,IAAI;AAAA,UACZ,UAAU,UAAU,YAAY;AAAA,UAChC,WAAU;AAAA,QAAA,CACV;AACKA,sBAAAA,MAAA,MAAM,OAAM,yDAAwD,GAAG;AAAA,MAAA,CAC3E;AAAA,IAAA;AAIH,UAAM,WAAWE,cAAA;AAAA,MAAS,MACxB,UAAU,gBAAgB,IAAI,CAAQ,QAAA;;AAAA;AAAA,UACpC,GAAG;AAAA,UACH,MAAM,IAAI,aAAW,eAAU,gBAAV,mBAAuB;AAAA,QAAA;AAAA,OAC5C;AAAA,IAAA;AAUJ,UAAM,cAAc,MAAM;AAGrB,UAAA,CAAC,UAAU,MAAM,KAAK;AAAG;AAE7B,gBAAU,YAAY,UAAU,MAAM,QAAO,OAAO,KAAK;AACzD,YAAM,MAAqB;AAAA,QACzB,QAAO,UAAU,YAAY;AAAA,QAC7B,SAAS,UAAU;AAAA,QACnB,UAAU,KAAK,IAAI;AAAA,QACnB,UAAU,OAAO;AAAA,MAAA;AAGnB,gBAAU,KAAK,KAAK,UAAU,GAAG,CAAC;AAClC,gBAAU,QAAQ;AACH;IAAA;AAIhB,UAAM,iBAAiB,MAAM;AAC3BC,oBAAAA,WAAS,MAAM;AACT,YAAA,UAAU,gBAAgB,SAAS,GAAG;AACxC,mBAAS,QAAQ,MAAM,UAAU,gBAAgB,SAAS,CAAC;AAAA,QAC7D;AAAA,MAAA,CACD;AAAA,IAAA;AAIHC,kBAAAA,UAAU,MAAM;AACA;AACC;IAAA,CAChB;AAEDC,kBAAAA,YAAY,MAAM;AACjB,6CAAW;AACPL,oBAAAA,MAAA,MAAM,OAAM,0DAAyD,MAAM;AACrE,gBAAA,iBAAiB,UAAU,gBAAgB;AACrD,gBAAU,mBAAmB;AAAA,IAAA,CAC7B;AAEDM,kBAAA,OAAO,CAAC,SAAO;AACP,aAAA,QAAQ,KAAK,MAAM;AACjB,eAAA,QAAQ,KAAK,YAAY;AAClC,aAAO,QAAQ,KAAK,SAAS,mBAAmB,KAAK,MAAM,IAAI;AAAA,IAAA,CAG/D;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACtJF,GAAG,WAAW,eAAe;"}