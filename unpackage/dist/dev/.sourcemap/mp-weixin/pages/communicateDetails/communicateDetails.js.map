{"version":3,"file":"communicateDetails.js","sources":["pages/communicateDetails/communicateDetails.vue","D:/HBuiderX/HBuilderX.4.64.2025042916/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY29tbXVuaWNhdGVEZXRhaWxzL2NvbW11bmljYXRlRGV0YWlscy52dWU"],"sourcesContent":["<template>\n\t<view class=\"main-container\">\n\t\t<scroll-view\n\t\t\tclass=\"chat-list\" \n\t\t\tscroll-y \n\t\t\t:scroll-into-view=\"scrollId\"\n\t\t\t:scroll-with-animation=\"true\"\n\t\t>\n\t\t\t<view\n\t\t\t\tv-for=\"(msg, index) in messages\" \n\t\t\t\t:key=\"msg.id\"\n\t\t\t\t:id=\"'msg'+index\"\n\t\t\t\tclass=\"message-container\"\n\t\t\t\t:class=\"[msg.isMe ? 'me' : 'other']\"\n\t\t\t>\n\t\t\t\t<image\n\t\t\t\t\tv-if=\"!msg.isMe\"\n\t\t\t\t\tclass=\"avatar\"\n\t\t\t\t\tsrc=\"/static/avatar-other.jpg\"\n\t\t\t\t\tmode=\"aspectFill\"\n\t\t\t\t/>\n\t\t\t\t<view class=\"bubble\">\n\t\t\t\t\t<text>{{ msg.content }}</text>\n\t\t\t\t</view>\n\t\t\t\t<image\n\t\t\t\t\tv-if=\"msg.isMe\"\n\t\t\t\t\tclass=\"avatar-me\"\n\t\t\t\t\tsrc=\"/static/avatar-me.jpg\"\n\t\t\t\t\tmode=\"aspectFill\"\n\t\t\t\t/>\n\t\t\t</view>\n\t\t</scroll-view>\n\t\t<view class=\"input-area\">\n\t\t\t<input \n\t\t\t\tclass=\"input\"\n\t\t\t\tv-model=\"inputText\"\n\t\t\t\tplaceholder=\"输入消息\"\n\t\t\t\tconfirm-type=\"send\"\n\t\t\t\t@confirm=\"sendMessage\"\n\t\t\t/>\n\t\t\t<button class=\"send-btn\" @click=\"sendMessage\">发送</button>\n\t\t</view>\n\t</view>\n</template>\n<script setup lang=\"ts\">\n\timport {onLoad} from '@dcloudio/uni-app'\n\timport { reactive,ref,nextTick, onMounted ,getCurrentInstance, computed, onUnmounted} from 'vue'\n\timport Vue from 'vue'\n\timport { useUserStore } from '../../store/useUserStore';\n\timport { useChatStore } from '../../store/chatStore';\n\timport {storeToRefs} from 'pinia'\n\timport websocketUtil from '../../script/webSocket';\n\timport { ServerURL,WebsocketURL } from '../../config';\n\timport { User } from '../../static/interface/User';\n\tconst chatStore = useChatStore()\n\tconst userStore = useUserStore()\n\t//uni.setStorageSync('userInfo',userStore.currentUser)\n\tconst inputText = ref('')\n\tconst scrollId = ref('')\n\tconst chatId = ref('')\n\tconst username = ref('')\n\tconst avatar = ref('')\n\tlet websocket = new websocketUtil(WebsocketURL+`${userStore.currentUser.id}`)\n\t\n\t// 初始化 WebSocket\n\tconst initWebSocket = () => {\n\t  //if (!userStore.currentUser?.id) return\n\t  \n\twebsocket.onMessage((res:any)=>{\n\t\tuni.__f__('log','at pages/communicateDetails/communicateDetails.vue:70',\"有人来消息了：\",res.sender)\n\t\tif (chatStore.sessions.find(s => s.id === res.sender)) {\n\t\t\tuni.__f__('log','at pages/communicateDetails/communicateDetails.vue:72',\"此消息的会话存在，不需要创建新的\")\n\t\t}\n\t\telse chatStore.createSession(res.sender)\n\t\tconst a=Date.now()\n\t\tconst s=a.toString()\n\t\tchatStore.handleIncomingMessage({\n\t\t\tid: s,\n\t\t\tcontent: res.content,\n\t\t\tsender: res.sender,\n\t\t\treceiver: userStore.currentUser.id,\n\t\t\ttimestamp:a\n\t\t})\n\t  \tuni.__f__('log','at pages/communicateDetails/communicateDetails.vue:84',res);\n\t  })\n\t}\n\t\n\t// 消息列表\n\tconst messages = computed(() => \n\t  chatStore.currentMessages.map(msg => ({\n\t    ...msg,\n\t    isMe: msg.sender === userStore.currentUser?.id\n\t  }))\n\t)\n\t\n\tinterface sendMessageTo{\n\t\tsender:string\n\t\tmessage:string\n\t\tsendTime:number\n\t\treceiver:string\n\t}\n\t// 发送消息\n\tconst sendMessage = () => {\n\t\t//去空格\n\t\t//uni.__f__('log','at pages/communicateDetails/communicateDetails.vue:105',\"000:\",userStore.currentUser.id)\n\t\tif (!inputText.value.trim()) return\n\t\t//加入本地\n\t\tchatStore.sendMessage(inputText.value.trim(),chatId.value)\n\t\tconst id:string=userStore.currentUser.id\n\t\tconst msg: sendMessageTo = {\n\t\t  sender:id,\n\t\t  message: inputText.value,\n\t\t  sendTime: Date.now(),\n\t\t  receiver: chatId.value\n\t\t}\n\t\tuni.__f__('log','at pages/communicateDetails/communicateDetails.vue:116',\"msg:\",msg)\n\t\twebsocket.send(JSON.stringify(msg))\n\t\tinputText.value = ''\n\t\tscrollToBottom()\n\t}\n\t\n\t// 滚动到底部\n\tconst scrollToBottom = () => {\n\t  nextTick(() => {\n\t    if (chatStore.currentMessages.length > 0) {\n\t      scrollId.value = `msg${chatStore.currentMessages.length - 1}`\n\t    }\n\t  })\n\t}\n\t\n\t// 生命周期\n\tonMounted(() => {\n\t  initWebSocket()\n\t  scrollToBottom()\n\t})\n\t\n\t/*onUnmounted(() => {\n\t\twebsocket?.close()\n\t\tuni.__f__('log','at pages/communicateDetails/communicateDetails.vue:139',\"关闭成功\")\n\t\tchatStore.clearUnreadCount(chatStore.currentSessionId)\n\t\tchatStore.currentSessionId = ''\n\t})*/\n\t\n\tonLoad((chat)=>{\n\t\tuserStore.currentUser=uni.getStorageSync('userInfo') as User\n\t\tchatId.value = chat.id || '未知ID'\n\t\tusername.value = chat.username || '匿名用户'\n\t\tavatar.value = chat.avatar ? decodeURIComponent(chat.avatar) : '/static/default-avatar.png'\n\t\t//uni.__f__('log','at pages/communicateDetails/communicateDetails.vue:149',\"123:\",userStore.meta.isLoggedin)\n\t\t//uni.setStorageSync('userInfo',userStore.currentUser)\n\t})\n\n</script>\n\n<style lang=\"scss\" scoped>\n.main-container {\n  height: 100vh;\n  background-color: #f0f2f5;\n  display: flex;\n  flex-direction: column;\n}\n\n.chat-list {\n  flex: 1;\n  padding: 20rpx 20rpx 0;\n  box-sizing: border-box;\n}\n\n.message-container {\n  display: flex;\n  align-items: flex-start;\n  margin-bottom: 30rpx;\n  padding: 0 20rpx;\n\n  // 自己消息\n  &.me {\n    flex-direction: row;  \n    justify-content: flex-end;  \n\n    .bubble {\n      background: #95ec69;\n      margin-left: 20rpx;  \n      order: 1; \n      border-radius: 10rpx;\n\t  padding: 18rpx 24rpx;\n\t  word-break: break-word; \n    }\n    \n    .avatar-me {\n      order: 2;  // 头像排在最后（右侧）\n      margin-left: 20rpx;  // 头像与气泡间距\n    }\n  }\n\n  // 他人消息\n  &.other {\n    flex-direction: row; \n    .bubble {\n      background: #ffffff;\n      margin-left: 20rpx;  \n      border-radius: 10rpx;\n\t  padding: 18rpx 24rpx;\n\t  word-break: break-word; \n    }\n    \n    .avatar {\n      order: -1;  \n    }\n  }\n}\n\n.avatar, .avatar-me {\n  width: 80rpx;\n  height: 80rpx;\n  border-radius: 50%;\n  flex-shrink: 0;\n  box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.1);\n}\n\n.input-area {\n  display: flex;\n  align-items: center;\n  padding: 30rpx 20rpx;\n  background: #ffffff;\n  border-top: 1rpx solid #e5e5e5;\n  margin-bottom: 10rpx;\n  .input {\n    flex: 1;\n    background: #f8f8f8;\n    border-radius: 48rpx;\n    padding: 20rpx 32rpx;\n    margin-right: 20rpx;\n    font-size: 30rpx;\n    transition: all 0.3s;\n\n    &:focus {\n      background: #f0f0f0;\n    }\n  }\n\n  .send-btn {\n    background: #07c160;\n    color: white;\n    border-radius: 48rpx;\n    padding: 0 40rpx;\n    height: 80rpx;\n    font-size: 30rpx;\n    transition: all 0.3s;\n    \n    &:active {\n      background: darken(#07c160, 8%);\n      transform: scale(0.96);\n    }\n  }\n}\n</style>\n\n","import MiniProgramPage from 'E:/uniappWorkSpace/SaltyFish/pages/communicateDetails/communicateDetails.vue'\nwx.createPage(MiniProgramPage)"],"names":["useChatStore","useUserStore","ref","websocketUtil","WebsocketURL","uni","s","computed","nextTick","onMounted","onLoad"],"mappings":";;;;;;;;;;AAsDC,UAAM,YAAYA,gBAAAA;AAClB,UAAM,YAAYC,mBAAAA;AAEZ,UAAA,YAAYC,kBAAI,EAAE;AAClB,UAAA,WAAWA,kBAAI,EAAE;AACjB,UAAA,SAASA,kBAAI,EAAE;AACf,UAAA,WAAWA,kBAAI,EAAE;AACjB,UAAA,SAASA,kBAAI,EAAE;AACjB,QAAA,YAAY,IAAIC,iBAAc,cAAAC,sBAAa,GAAG,UAAU,YAAY,EAAE,EAAE;AAG5E,UAAM,gBAAgB,MAAM;AAGlB,gBAAA,UAAU,CAAC,QAAU;AAC9BC,sBAAA,MAAI,MAAM,OAAM,yDAAwD,WAAU,IAAI,MAAM;AACxF,YAAA,UAAU,SAAS,KAAK,CAAAC,OAAKA,GAAE,OAAO,IAAI,MAAM,GAAG;AAClDD,wBAAAA,MAAA,MAAM,OAAM,yDAAwD,kBAAkB;AAAA,QAC3F;AACe,oBAAA,cAAc,IAAI,MAAM;AACjC,cAAA,IAAE,KAAK;AACP,cAAA,IAAE,EAAE;AACV,kBAAU,sBAAsB;AAAA,UAC/B,IAAI;AAAA,UACJ,SAAS,IAAI;AAAA,UACb,QAAQ,IAAI;AAAA,UACZ,UAAU,UAAU,YAAY;AAAA,UAChC,WAAU;AAAA,QAAA,CACV;AACKA,sBAAAA,MAAA,MAAM,OAAM,yDAAwD,GAAG;AAAA,MAAA,CAC3E;AAAA,IAAA;AAIH,UAAM,WAAWE,cAAA;AAAA,MAAS,MACxB,UAAU,gBAAgB,IAAI,CAAQ,QAAA;;AAAA;AAAA,UACpC,GAAG;AAAA,UACH,MAAM,IAAI,aAAW,eAAU,gBAAV,mBAAuB;AAAA,QAAA;AAAA,OAC5C;AAAA,IAAA;AAUJ,UAAM,cAAc,MAAM;AAGrB,UAAA,CAAC,UAAU,MAAM,KAAK;AAAG;AAE7B,gBAAU,YAAY,UAAU,MAAM,QAAO,OAAO,KAAK;AACnD,YAAA,KAAU,UAAU,YAAY;AACtC,YAAM,MAAqB;AAAA,QACzB,QAAO;AAAA,QACP,SAAS,UAAU;AAAA,QACnB,UAAU,KAAK,IAAI;AAAA,QACnB,UAAU,OAAO;AAAA,MAAA;AAEnBF,oBAAA,MAAI,MAAM,OAAM,0DAAyD,QAAO,GAAG;AACnF,gBAAU,KAAK,KAAK,UAAU,GAAG,CAAC;AAClC,gBAAU,QAAQ;AACH;IAAA;AAIhB,UAAM,iBAAiB,MAAM;AAC3BG,oBAAAA,WAAS,MAAM;AACT,YAAA,UAAU,gBAAgB,SAAS,GAAG;AACxC,mBAAS,QAAQ,MAAM,UAAU,gBAAgB,SAAS,CAAC;AAAA,QAC7D;AAAA,MAAA,CACD;AAAA,IAAA;AAIHC,kBAAAA,UAAU,MAAM;AACA;AACC;IAAA,CAChB;AASDC,kBAAA,OAAO,CAAC,SAAO;AACJ,gBAAA,cAAYL,cAAAA,MAAI,eAAe,UAAU;AAC5C,aAAA,QAAQ,KAAK,MAAM;AACjB,eAAA,QAAQ,KAAK,YAAY;AAClC,aAAO,QAAQ,KAAK,SAAS,mBAAmB,KAAK,MAAM,IAAI;AAAA,IAAA,CAG/D;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrJF,GAAG,WAAW,eAAe;"}