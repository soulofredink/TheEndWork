{"version":3,"file":"sell.js","sources":["pages/sell/sell.vue","D:/HBuiderX/HBuilderX.4.64.2025042916/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvc2VsbC9zZWxsLnZ1ZQ"],"sourcesContent":["<template>\n\t<view class=\"container\">\n\t\t<!-- 图片上传区域 -->\n\t\t<view class=\"image-box\" @tap=\"addImage\" :class=\"{ 'image-active': !isText }\">\n\t\t\t<text v-if=\"isText\" class=\"tip-text\">+ 点击添加商品图片</text>\n\t\t\t<image \n\t\t\t\tv-if=\"!isText\"\n\t\t\t\tmode=\"aspectFill\" \n\t\t\t\t:src=\"src\" \n\t\t\t\tclass=\"preview-image\"\n\t\t\t\t@tap.stop=\"handleImageTap\"\n\t\t\t/>\n\t\t\t<view v-if=\"!isText\" class=\"delete-mask\" @tap.stop=\"deleteImage\">\n\t\t\t\t<text class=\"iconfont icon-shanchu\">X</text>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<!-- 商品信息表单 -->\n\t\t<view class=\"goods-info\">\n\t\t\t<uni-forms :modelValue=\"good\">\n\t\t\t\t<uni-forms-item label=\"名称\" name=\"name\">\n\t\t\t\t\t<input type=\"text\" v-model=\"good.name\" placeholder=\"请输入商品名称\" @blur=\"isVaild('name')\"/>\n\t\t\t\t</uni-forms-item>\n\t\t\t\t<uni-forms-item label=\"价格\" name=\"price\">\n\t\t\t\t\t<input type=\"text\" v-model=\"good.price\" placeholder=\"请输入价格\" @blur=\"isVaild('price')\"/>\n\t\t\t\t</uni-forms-item>\n\t\t\t\t<uni-forms-item required name=\"type\" label=\"类型\">\n\t\t\t\t\t<input  v-model=\"type\" placeholder=\"商品类型\" @tap=\"chooseType\" @blur=\"isVaild('type')\" readonly/>\n\t\t\t\t</uni-forms-item>\n\t\t\t\t<uni-forms-item required name=\"description\" label=\"描述\" >\n\t\t\t\t\t<textarea \n\t\t\t\t\t      v-model=\"good.description\"\n\t\t\t\t\t      placeholder=\"请输入商品描述（140字以内）\"\n\t\t\t\t\t      placeholder-style=\"color: #999;\"\n\t\t\t\t\t      auto-height\n\t\t\t\t\t\t  @focus=\"changeIsFocus\"\n\t\t\t\t\t\t  @blur=\"onBlur\"\n\t\t\t\t\t\t  :class=\"{\n\t\t\t\t\t\t        'description-box': true,\n\t\t\t\t\t\t        'description-focus': isFocus\n\t\t\t\t\t\t      }\"\r\n\t\t\t\t\t\t\n\t\t\t\t\t    />\n\t\t\t\t\t    <!-- 字数统计 -->\n\t\t\t\t\t    <view class=\"word-count\">\n\t\t\t\t\t      {{ good.description.length }}/140\n\t\t\t\t\t    </view>\n\t\t\t\t</uni-forms-item>\n\t\t\t</uni-forms>\r\n\t\t\t<view class=\"submit-btn\">\r\n\t\t\t\t<button type=\"primary\" @click=\"submitForm\">立即发布</button>\r\n\t\t\t</view>\n\t\t</view>\n\t</view>\n</template>\n\n<script setup lang=\"ts\">\nimport { computed, reactive, ref,watch, watchEffect } from 'vue'\nimport { useUserStore } from '../../store/useUserStore'\nimport {onLoad} from '@dcloudio/uni-app'\r\nimport {User} from \"../../static/interface/User\"\r\nimport { Goods } from '../../static/interface/goods'\r\nimport { ServerURL,WebsocketURL } from '../../config'\r\nenum GOODS_TYPE {\r\n\tBOOK= 0,\r\n\tGAME=1,\r\n\tLIFE_UTIL=2,\r\n}\nlet isType = ref(false)\r\nlet isName = ref(false)\r\nlet isPrice = ref(false)\r\nlet isDescription = ref(false)\r\nconst good : Goods = reactive({\r\n  userId:\"\",                 // computed(() => userStore.currentUser?.id || \"\"),\r\n  name: \"\", \r\n  price: null,\r\n  description: \"\",\r\n  image: \"\",\r\n  type:null,\r\n})\r\nlet type = ref(\"\")\nconst userStore = useUserStore();\nconst isText = ref(true);\nconst src = ref(\"\");\nconst formRef = ref();\nlet isFocus = ref(false)\n//检测逻辑变量\nfunction showError(title:string){\r\n\tuni.showToast({\r\n\t\ttitle,\r\n\t\ticon:\"none\",\r\n\t\tduration:3000,\r\n\t})\r\n}\r\nfunction isVaild(Type:string){\r\n\tswitch(Type){\r\n\t\tcase \"type\":\r\n\t\tif(type.value != '游戏' && type.value != '图书' && type.value != '生活用品'){\r\n\t\t\tshowError(\"商品类型错误\")\r\n\t\t\tisType.value = false\r\n\t\t}else{\r\n\t\t\tisType.value = true\r\n\t\t}\r\n\t\tbreak\r\n\t\tcase \"name\":\r\n\t\tif(good.name == '' || good.name.length > 20){\r\n\t\t\tshowError(\"商品名字长度1-20\")\r\n\t\t\tisName.value = false\r\n\t\t}else{\r\n\t\t\tisName.value = true\r\n\t\t}\r\n\t\tbreak;\r\n\t\tcase 'price':\r\n\t\tconst pricePattern = /(^[1-9]\\d*(\\.\\d{1,2})?$)|(^0(\\.\\d{1,2})?$)/\r\n\t\tif(!pricePattern.test(good.price)){\r\n\t\t\tshowError(\"价钱格式有误\")\r\n\t\t\tisPrice.value = false\r\n\t\t}else{\r\n\t\t\tisPrice.value = true\r\n\t\t}\r\n\t\tbreak;\r\n\t\tcase 'description':\r\n\t\tif(good.description.length < 12 || good.description.length > 140){\r\n\t\t\tshowError(\"商品介绍长度有误(12-144)\")\r\n\t\t\tisDescription.value = false\r\n\t\t}else{\r\n\t\t\tisDescription.value = true\r\n\t\t}\r\n\t\tbreak;\r\n\t}\r\n}\r\n\nfunction changeIsFocus(){\n\tisFocus.value = true;\n}\n\n\t\nfunction onBlur(){\n\tisFocus.value = false\r\n\tisVaild(\"description\")\n}\n\nconst itemList = [\"图书\",\"游戏\",\"生活用品\"]\nfunction chooseType(){\n\tuni.showActionSheet({\n\t\titemList,\n\t\tsuccess: (res) => {\n\t\t\ttype.value = itemList[res.tapIndex]; \n\t\t}\n\t})\n}\n\n// 添加图片\nfunction addImage() {\n\tuni.chooseImage({\n\t\tcount: 1,\n\t\tsizeType: ['compressed'],\n\t\tsourceType: ['album', 'camera'],\n\t\tsuccess: (res) => {\n\t\t\tif (res.tempFilePaths[0]) {\n\t\t\t\tisText.value = false;\n\t\t\t\tsrc.value = res.tempFilePaths[0];\n\t\t\t\tgood.image = src.value;\n\t\t\t}\n\t\t},\n\t\tfail: (err) => {\n\t\t\tuni.showToast({\n\t\t\t\ttitle: '图片选择失败',\n\t\t\t\ticon: 'none'\n\t\t\t});\n\t\t}\n\t});\n}\n\n// 删除图片\nfunction deleteImage() {\n\tuni.showModal({\n\t\ttitle: '提示',\n\t\tcontent: '确定要删除这张图片吗？',\n\t\tsuccess: (res) => {\n\t\t\tif (res.confirm) {\n\t\t\t\tisText.value = true;\n\t\t\t\tsrc.value = \"\";\n\t\t\t\tgood.image = \"\";\n\t\t\t}\n\t\t}\n\t});\n}\n\n// 提交表单\nasync function submitForm() {\n\tif(!isName || !isPrice || !isType || !isDescription){\r\n\t\tuni.showToast({\r\n\t\t\ttitle:\"输入项有误,请点击每项并退出焦点查看错误原因\",\r\n\t\t\ticon:\"none\",\r\n\t\t\tduration:3000,\r\n\t\t})\r\n\t\treturn\r\n\t}\n\t\t\n\tif (!good.image) {\n\t\treturn uni.showToast({ title: '请上传商品图片', icon: 'none' });\n\t}\r\n\tuni.showLoading({\r\n\t\ttitle: \"正在发布中....\"\r\n\t})\n\tgood.userId=userStore.currentUser.id;\r\n\t//获得图片的服务器URL\r\n\ttry{\r\n\t\tconst res = await uploadToServer(good.image)\r\n\t\tgood.image = res;\r\n\t}catch(err){\r\n\t\tuni.__f__('log','at pages/sell/sell.vue:213',err)\r\n\t}\r\n\tif(type.value == \"图书\"){\r\n\t\tgood.type = GOODS_TYPE.BOOK\r\n\t}else if(type.value == \"游戏\"){\r\n\t\tgood.type = GOODS_TYPE.GAME\r\n\t}else{\r\n\t\tgood.type = GOODS_TYPE.LIFE_UTIL\r\n\t}\r\n\tuni.request({\r\n\t\turl: ServerURL + \"/sending/goods\",\r\n\t\tmethod:'POST',\r\n\t\theader:{\r\n\t\t\t'Content-Type': 'application/json'\r\n\t\t},\r\n\t\tdata:JSON.stringify(good),\r\n\t\tsuccess: (res) => {\r\n\t\t\tuni.hideLoading()\r\n\t\t\tif(res.statusCode == 200){\r\n\t\t\t\tuni.showModal({\r\n\t\t\t\t  title:\"发布成功\",\r\n\t\t\t\t  confirmText:\"确认\"\r\n\t\t\t\t})\r\n\t\t\t\t\r\n\t\t\t\tisText.value = true;\r\n\t\t\t\tsrc.value = \"\";\r\n\t\t\t\tgood.image = \"\";\r\n\t\t\t\tgood.name = \"\";\r\n\t\t\t\tgood.price = null;\r\n\t\t\t\tgood.type = null;\r\n\t\t\t\ttype.value = \"\";\r\n\t\t\t\tgood.description = \"\";\r\n\t\t\t}\r\n\t\t}\r\n\t})\n}\n\n// 点击图片预览\nfunction handleImageTap() {\n\tuni.previewImage({\n\t\turls: [src.value],\n\t\tcurrent: 0\n\t});\n}\r\n//上传图像到服务器并获得图片访问地址\nconst uploadToServer = async (filePath:string) => {\n\t  const {statusCode,data} = await uni.uploadFile({\n\t      url:\"http://192.168.43.78:8080/\" + type.value,\n\t      filePath: filePath, \n\t      name:'file',     \n\t  })\n\t  if (statusCode === 200) {\n\t\tlet res = JSON.parse(data)\n\t    return res.data; \n\t  }else{\r\n\t\t  uni.showToast({\r\n\t\t  \ttitle:\"图片上传失败\"\r\n\t\t  })\r\n\t\t  throw new Error('上传失败');\r\n\t  }\n}\nonLoad(()=>{\r\n\tuserStore.currentUser= uni.getStorageSync('userInfo') as User\r\n})\n</script>\n\n<style lang=\"scss\" scoped>\n.container {\n\tpadding: 30rpx;\n}\n\n.image-box {\n\theight: 450rpx;\n\twidth: 100%;\n\tborder: 2rpx dashed #ddd;\n\tborder-radius: 16rpx;\n\tdisplay: flex;\n\tjustify-content: center;\n\talign-items: center;\n\tbackground: #f9f9f9;\n\tposition: relative;\n\toverflow: hidden;\n\timage{\n\t\twidth: 100%;\n\t\theight: 100%;\n\t}\n\t&.image-active {\n\t\tborder-color: #007AFF;\n\t\tbackground: #f0f7ff;\n\t}\n\n\t.tip-text {\n\t\tcolor: #666;\n\t\tfont-size: 28rpx;\n\t}\n\n\t.preview-image {\n\t\twidth: 100%;\n\t\theight: 100%;\n\t\ttransition: transform 0.3s;\n\t\t\n\t\t&:active {\n\t\t\ttransform: scale(0.98);\n\t\t}\n\t}\n\n\t.delete-mask {\n\t\tdisplay:flex;\n\t\tposition: absolute;\n\t\tright: 0;\n\t\ttop: 0;\n\t\tbackground: rgba(0,0,0,0.5);\n\t\tpadding: 10rpx 16rpx;\n\t\tborder-radius: 0 0 0 16rpx;\n\t\twidth:30rpx;\n\t\theight:30rpx;\n\t\tjustify-self: center;\n\t\talign-items: center;\n\t\t.icon-shanchu {\n\t\t\tcolor: #b2b2b2;\n\t\t\tfont-size: 36rpx;\n\t\t}\n\t}\n}\n\n\t.goods-info {\n\t\tmargin-top: 40rpx;\n\t\tposition: relative;\n\t\tinput{\n\t\t\tposition: absolute;\n\t\t\ttop:12rpx;\n\t\t}\n\t}\n\t\n    .submit-btn {\n\tmargin: 60rpx 30rpx 0;\n\t\n\tbutton {\n\t\tborder-radius: 50rpx;\n\t\theight: 88rpx;\n\t\tfont-size: 32rpx;\n\t}\n}\n\tdescription-box {\n\t  /* 基础样式 */\n\t  width: 100%;\n\t  min-height: 200rpx;\n\t  padding: 20rpx;\n\t  border: 2rpx solid #e5e5e5;\n\t  border-radius: 12rpx;\n\t  font-size: 28rpx;\n\t  line-height: 1.5;\n\t  color: #333;\n\t  box-sizing: border-box;\n\t  overflow-y: visible;\n\t}\n  /* 聚焦状态 */\n  description-focus {\n    border-color: #007AFF;\n    outline: none;\n  }\n</style>","import MiniProgramPage from 'E:/uniappWorkSpace/SaltyFish/pages/sell/sell.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","reactive","useUserStore","uni","ServerURL","onLoad"],"mappings":"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"}